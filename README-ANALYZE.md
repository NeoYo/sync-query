

> æœ¬æ–‡è¿˜åŸä»äº§å“æå‡ºè·¯ç”±å‚æ•°åŒæ­¥çš„éœ€æ±‚ï¼Œåˆ°ä»£ç å®ç°ã€æŠ½ç¦»å°è£…çš„è¿‡ç¨‹ã€‚æ¶‰åŠé«˜é˜¶ç»„ä»¶ã€ES6ç±»ç»§æ‰¿å’Œ AOPç¼–ç¨‹

# éœ€æ±‚æ¥å•¦~

## éœ€æ±‚åœºæ™¯

ä»Šå¹´å¹¿ä¸œçš„å†¬å¤©æœ‰ç‚¹å†·ï¼Œæˆ‘å¦‚åŒå¾€å¸¸ä¸€èˆ¬ï¼Œæˆ´ç€30dbé™å™ªè€³æœºï¼Œæ•²ç€çº¢è½´æœºæ¢°é”®ç›˜ï¼Œåœ¨ä»£ç çš„æµ·æ´‹é‡Œé¨æ¸¸(<del>è¢«Bugæ‘åœ¨åœ°ä¸Šä¸æ–­æ‘©æ“¦</del>)

äº§å“å°å§å§çªç„¶èµ°åˆ°æˆ‘èº«åï¼Œæ‹äº†æ‹æˆ‘çš„è‚©è†€ï¼Œè¦æ±‚å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼ŒæŠŠè¿è¥å°å§å§å¡«å†™çš„æ–‡å­—ã€ä¸‹æ‹‰æ¡†é€‰æ‹©äº†ç¬¬å‡ ä¸ªç­‰ï¼Œåˆ†äº«ç»™å…¶ä»–è¿è¥å°ä¼™ä¼´(ï¿£Ï‰ï¿£(ï¿£Ï‰ï¿£ã€ƒ (ï¿£Ï‰ï¿£ã€ƒ)ã‚ã€‚

åœ¨åå°ç®¡ç†ä¸­ï¼Œç•Œé¢å¸¸å¸¸ä¼šæœ‰å‡ ä¸ªç­›é€‰æ¡ä»¶ï¼Œåœ¨è¾“å…¥æ¡†å¡«å†™ã€ä¸‹æ‹‰æ¡†é€‰æ‹©ç­‰ï¼Œå¡«å†™å®Œæ—¶ï¼Œå°†æœåŠ¡ç«¯çš„æ•°æ®æ‹‰å–å±•ç¤ºåœ¨è¡¨æ ¼ä¸­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º:

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/914599a657cc44c9861e1f1b2b41b1d8~tplv-k3u1fbpfcp-watermark.image)

## ä»£ç å®ç°
    
æŠŠå¡«å†™çš„ä¿¡æ¯ï¼Œä¿å­˜åˆ°ç½‘å€è·¯ç”±å‚æ•°ã€‚é‚£ä¹ˆåˆ†äº«çš„ç½‘å€ï¼Œå°±å¸¦äº†è¾“å…¥ä¿¡æ¯ï¼Œè¿™æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„æ–¹å¼ã€‚

æ¯ä¸ªç­›é€‰æ¡ä»¶è¾“å…¥å€¼ä¿®æ”¹ï¼Œè§¦å‘è·¯ç”±å‚æ•°æ›´æ–°ã€‚

å½“è¿›å…¥ç•Œé¢æ—¶ï¼Œä»è·¯ç”±å‚æ•°è·å– React state çš„åˆå§‹å€¼ã€‚

å®ç°å¦‚ä¸‹å›¾æ‰€ç¤º:

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/837cc0c049494d61ba74fcea3ea95e2f~tplv-k3u1fbpfcp-watermark.image)

# ä½•ä»¥è§£è€¦

## æŠ€æœ¯é—®é¢˜

æ—§çš„å¤§é‡ä»£ç ï¼ŒåŸºæœ¬éƒ½æ˜¯ç”¨ React Class + TypeScript çš„å†™æ³•ï¼Œå»å¼€å‘æ¯ä¸€ä¸ªç•Œé¢ã€‚

æ¯ä¸ªç•Œé¢ï¼Œéƒ½åœ¨è¾“å…¥æ¡†ã€ä¸‹æ‹‰æ¡†ç­‰é€‰æ‹©æ¡ä»¶å˜æ›´æ—¶ï¼ŒæŠŠä¿¡æ¯å­˜å‚¨åˆ°è·¯ç”±å‚æ•°ä¸Šï¼Œè¿™éƒ¨åˆ†ä»£ç ä¸å¤šä¹Ÿä¸å°‘ï¼Œä½†å®ƒä¸æ¯ä¸ªé¡µé¢çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å…³ç³»ä¸é‚£ä¹ˆå¯†åˆ‡

å¼€å‘åå°ç®¡ç†æ–°ç•Œé¢æ—¶ï¼Œæ›´å…³æ³¨æ–°çš„åŠŸèƒ½ç‚¹ï¼Œå´å¸¸å¸¸è¦åœ¨æ¯ä¸€ä¸ªç•Œé¢é‡Œå»å¼€å‘ã€ç»´æŠ¤è·¯ç”±å‚æ•°åŒæ­¥ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½

ä¸šåŠ¡éœ€æ±‚ï¼ˆä¿å­˜ç­›é€‰æ¡ä»¶ï¼‰-> ä»£ç å®ç°ï¼ˆè·¯ç”±å‚æ•°åŒæ­¥ï¼‰-> é¡µé¢ä¸šåŠ¡éœ€æ±‚ä¸è·¯ç”±å‚æ•°åŒæ­¥è€¦åˆ -> è·¯ç”±å‚æ•°åŒæ­¥åŠŸèƒ½æŠ½ç¦»

## Reactç»„ä»¶å°è£…

### 1. props.children
    
ç¤ºä¾‹å¦‚ä¸‹:

```js
// components/MyLayout.js
const layoutStyle = {
  margin: 20,
  padding: 20,
  border: '1px solid #DDD'
};

const Layout = props => (
  <div style={layoutStyle}>
    <Header />
    {props.children}
  </div>
);

export default Layout;

// pages/index.js
import Layout from '../components/MyLayout';

export default function Index() {
  return (
    <Layout>
      <p>Hello Next.js</p>
    </Layout>
  );
}

// pages/about.js
import Layout from '../components/MyLayout';

export default function About() {
  return (
    <Layout>
      <p>This is the about page</p>
    </Layout>
  );
}
```

### 2. Higher Order Component é«˜é˜¶ç»„ä»¶

ç¤ºä¾‹å¦‚ä¸‹:

```js
// components/MyLayout.js
import Header from './Header';

const layoutStyle = {
  margin: 20,
  padding: 20,
  border: '1px solid #DDD'
};

const withLayout = Page => {
  return () => (
    <div style={layoutStyle}>
      <Header />
      <Page />
    </div>
  );
};

export default withLayout;

// pages/index.js
import withLayout from '../components/MyLayout';

const Page = () => <p>Hello Next.js</p>;

export default withLayout(Page);

// pages/about.js

import withLayout from '../components/MyLayout';

const Page = () => <p>This is the about page</p>;

export default withLayout(Page);
```

### 3. Page content as props

ç¤ºä¾‹å¦‚ä¸‹:

```js
// components/MyLayout.js

import Header from './Header';

const layoutStyle = {
  margin: 20,
  padding: 20,
  border: '1px solid #DDD'
};

const Layout = props => (
  <div style={layoutStyle}>
    <Header />
    {props.content}
  </div>
);

export default Layout;

// pages/index.js

import Layout from '../components/MyLayout.js';

const indexPageContent = <p>Hello Next.js</p>;

export default function Index() {
  return <Layout content={indexPageContent} />;
};

// pages/about.js

import Layout from '../components/MyLayout.js';

const aboutPageContent = <p>This is the about page</p>;

export default function About() {
  return <Layout content={aboutPageContent} />;
}
```

## é€‰å“ªç§å°è£…ï¼Ÿ

ä»”ç»†é˜…è¯»ä¸Šé¢çš„ä»£ç ï¼Œä¼šå‘ç°é€‰å“ªä¸€ç§ä»£ç ï¼Œéƒ½ä¸é€‚åˆæˆ‘ä»¬çš„åœºæ™¯ï¼Œå› ä¸ºå®ƒä»¬åªæ¶‰åŠçˆ¶ç»„ä»¶å’Œå­ç»„ä»¶ä¹‹é—´çš„åµŒå¥—ï¼ŒæœŸæœ›æ˜¯æ¨ªå‘æŠ½ç¦»å‡ºè·¯ç”±å‚æ•°çš„ä»£ç ã€‚

å…¶ä¸­ä¸€ç§æ˜¯é«˜é˜¶ç»„ä»¶ï¼Œåœ¨ React çš„å®˜æ–¹æ–‡æ¡£é‡Œï¼Œæœ‰ä»‹ç»åˆ° [é«˜é˜¶ç»„ä»¶](https://react.docschina.org/docs/higher-order-components.html) ä½œç”¨ï¼Œè§£å†³æ¨ªåˆ‡å…³æ³¨ç‚¹é—®é¢˜ã€‚

å¯¹äºé«˜é˜¶ç»„ä»¶ï¼Œåœ¨ JSå‡½æ•°å¼ç¼–ç¨‹ä¸­ï¼Œé«˜é˜¶å‡½æ•°çš„ä½œç”¨ï¼Œå°±æ˜¯æ¥æ”¶ä¸€ä¸ªå‡½æ•°ï¼Œè¿›è¡Œå¢å¼ºï¼ˆåœ¨ä¼ å‚ã€è¿”å›å€¼åšäº›æ‰‹è„šï¼‰ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ã€‚æ‹“å±•åˆ°é«˜é˜¶ç»„ä»¶ï¼Œå‡½æ•°å˜æˆç»„ä»¶ï¼Œæ¥æ”¶ä¸€ä¸ªç»„ä»¶ï¼Œè¿›è¡Œå¢å¼ºï¼Œè¿”å›ä¸€ä¸ªç»„ä»¶

æˆ‘ä»¬çœ‹çœ‹å®˜ç½‘ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå®ƒæ¥å— WrappedComponent ç»„ä»¶ï¼Œè¿”å› `class extends React.Component` ç»„ä»¶ï¼Œå¢åŠ è®¢é˜…å’Œæ›´æ–° data é€»è¾‘ï¼Œè€Œè¿™ä¸ªé€»è¾‘ï¼Œæ˜¯åœ¨å¤šä¸ªç»„ä»¶ä¸­å…±ç”¨çš„ã€‚

```js
// æ­¤å‡½æ•°æ¥æ”¶ä¸€ä¸ªç»„ä»¶...
function withSubscription(WrappedComponent, selectData) {
  // ...å¹¶è¿”å›å¦ä¸€ä¸ªç»„ä»¶...
  return class extends React.Component {
    constructor(props) {
      super(props);
      this.handleChange = this.handleChange.bind(this);
      this.state = {
        data: selectData(DataSource, props)
      };
    }

    componentDidMount() {
      // ...è´Ÿè´£è®¢é˜…ç›¸å…³çš„æ“ä½œ...
      DataSource.addChangeListener(this.handleChange);
    }

    componentWillUnmount() {
      DataSource.removeChangeListener(this.handleChange);
    }

    handleChange() {
      this.setState({
        data: selectData(DataSource, this.props)
      });
    }

    render() {
      // ... å¹¶ä½¿ç”¨æ–°æ•°æ®æ¸²æŸ“è¢«åŒ…è£…çš„ç»„ä»¶!
      // è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜ä¼šä¼ é€’å…¶ä»–å±æ€§
      return <WrappedComponent data={this.state.data} {...this.props} />;
    }
  };
}
```

ç±»æ¯”åˆ°å½“å‰å°† React state åŒæ­¥åˆ°è·¯ç”±å‚æ•°çš„JSé€»è¾‘ï¼Œä¹Ÿæ˜¯åŒæ ·çš„é¢å‘åˆ‡é¢çš„é€»è¾‘ğŸ¤”

å…´é«˜é‡‡çƒˆåœ°å‡†å¤‡å‘Šè¯‰é˜Ÿå‹ä»¬ã€‚

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e6ec8a3498c1418ebce172810d9d7805~tplv-k3u1fbpfcp-watermark.image)

é…é…¿å¥½äº†...

è½¬å‘å·¦è¾¹ï¼Œè·Ÿé£å“¥è¯´äº†ä¸€é€šï¼Œå¥¹ç‚¹äº†ç‚¹å¤´ï¼Œè¯´äº†ä¸€å¥è¯ï¼Œå¯ä»¥æ”¹ï¼Œä¸èƒ½æœ‰bugã€‚

è½¬å‘å³è¾¹ï¼Œç»™ç‹å“¥ï¼Œå·´æ‹‰å·´æ‹‰åˆè¯´äº†ä¸€é€šï¼Œä»–å›äº†ä¸¤å¥è¯ã€‚å“¦ã€‚æ’æœŸæ—¶é—´ä¸èƒ½å˜ã€‚

OK. é˜Ÿå‹ä»¬éƒ½å‘ŠçŸ¥å¥½äº†ã€‚

Em... æƒ³æ³•éƒ½æœ‰äº†ï¼Œåªå·®ä¸€ä¸ªå¼€å‘äº†...

# å®ç°è‡ªåŠ¨ç›‘å¬

ï¼ˆæœªå®Œå¾…ç»­ï¼‰

ä»£ç åœ°å€: https://github.com/NeoYo/sync-query æ¬¢è¿ Starï¼ŒThanksâ™ª(ï½¥Ï‰ï½¥)ï¾‰


